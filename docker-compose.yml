version: '3.4'
services:
  zeo:
    build:
      context: .
      dockerfile: Dockerfile-dev
    image: iasmartweb-dev
    user: imio
    volumes:
      - ./var/blobstorage:/home/imio/imio-website/var/blobstorage
      - ./var/filestorage:/home/imio/imio-website/var/filestorage
    working_dir: /home/imio/imio-website
    healthcheck:
      test: ['CMD', 'nc', '-z', '-w5', '127.0.0.1', '8100']
    command: /home/imio/imio-website/bin/zeoserver fg
  instance:
    image: iasmartweb-dev
    user: imio
    ports:
      - "8081:8081"
    links:
      - zeo:db
    depends_on:
      - reverseproxy
    volumes:
      - ./src:/home/imio/imio-website/src
      - ./dev.cfg:/home/imio/imio-website/dev.cfg
      - ./var/instance/minisites:/home/imio/imio-website/var/instance/minisites
    working_dir: /home/imio/imio-website
    environment:
      - MEMCACHE_SERVER=172.17.0.1
      - MEMCACHE_DEFAULT_AGE=10800
      - ENV=dev
      - CACHING_SERVERS=http://frontend1.interne.imio.be:5000 http://frontend2.lan.imio.be:5000 http://frontend3.lan.imio.be:5000
      - DOMAINS=localhost
      - ZEO_HOST=db
      - ZEO_PORT=8100
    command: /home/imio/imio-website/bin/instance fg
  reverseproxy:
    image: traefik:1.7 # The official Traefik docker image
    command: --api --docker # Enables the web UI and tells Tr√¶fik to listen to docker
    ports:
      - "80:80"     # The HTTP port
      - "8000:8080" # The Web UI (enabled by --api)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # So that Traefik can listen to the Docker events
      - $PWD/traefik.toml:/etc/traefik/traefik.toml
